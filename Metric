package com.example.axonmetricsdemo.config;

import com.codahale.metrics.MetricRegistry;
import org.axonframework.config.Configurer;
import org.axonframework.config.DefaultConfigurer;
import org.axonframework.metrics.MessageCountingMonitor;
import org.axonframework.messaging.MessageMonitor;
import org.springframework.boot.web.servlet.ServletRegistrationBean;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import com.codahale.metrics.servlets.MetricsServlet;

@Configuration
public class AxonMetricsConfig {

    @Bean
    public MetricRegistry metricRegistry() {
        return new MetricRegistry();
    }

    @Bean
    public org.axonframework.config.Configuration axonConfiguration(MetricRegistry metricRegistry) {
        Configurer configurer = DefaultConfigurer.defaultConfiguration()
                .configureMessageMonitor((configuration, componentType, componentName) ->
                        MessageCountingMonitor.buildMonitor(componentName, metricRegistry)
                );

        org.axonframework.config.Configuration configuration = configurer.buildConfiguration();
        configuration.start();
        return configuration;
    }

    @Bean
    public ServletRegistrationBean<MetricsServlet> metricsServlet(MetricRegistry metricRegistry) {
        return new ServletRegistrationBean<>(new MetricsServlet(metricRegistry), "/metrics/*");
    }
}
